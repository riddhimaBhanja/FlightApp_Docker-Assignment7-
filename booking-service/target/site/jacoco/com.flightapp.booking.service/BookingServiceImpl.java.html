<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Booking Service</a> &gt; <a href="index.source.html" class="el_package">com.flightapp.booking.service</a> &gt; <span class="el_source">BookingServiceImpl.java</span></div><h1>BookingServiceImpl.java</h1><pre class="source lang-java linenums">package com.flightapp.booking.service;

import com.flightapp.booking.config.FlightServiceClient;
import com.flightapp.booking.dto.BookingRequest;
import com.flightapp.booking.dto.BookingResponse;
import com.flightapp.booking.dto.EmailNotification;
import com.flightapp.booking.dto.FlightInventory;
import com.flightapp.booking.entity.Booking;
import com.flightapp.booking.exception.*;
import com.flightapp.booking.messaging.EmailService;
import com.flightapp.booking.repository.BookingRepository;
import io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;
import reactor.core.scheduler.Schedulers;

import java.time.LocalDateTime;
import java.util.UUID;

@Service
<span class="fc" id="L23">@RequiredArgsConstructor</span>
<span class="fc" id="L24">@Slf4j</span>
public class BookingServiceImpl implements BookingService {

    private final BookingRepository bookingRepository;
    private final FlightServiceClient flightServiceClient;
    private final EmailService emailService;

    @Override
    @CircuitBreaker(name = &quot;bookingService&quot;, fallbackMethod = &quot;createBookingFallback&quot;)
    public Mono&lt;BookingResponse&gt; createBooking(BookingRequest request) {
<span class="fc" id="L34">        return Mono.fromCallable(() -&gt; {</span>
<span class="fc" id="L35">            FlightInventory flight = flightServiceClient.getFlightById(request.getFlightId());</span>

<span class="fc bfc" id="L37" title="All 2 branches covered.">            if (flight == null) {</span>
<span class="fc" id="L38">                throw new FlightNotFoundException(&quot;Flight not found&quot;);</span>
            }

<span class="fc bfc" id="L41" title="All 2 branches covered.">            if (flight.getAvailableSeats() &lt; request.getNumberOfSeats()) {</span>
<span class="fc" id="L42">                throw new InsufficientSeatsException(&quot;Insufficient seats available&quot;);</span>
            }

<span class="fc" id="L45">            Boolean seatsReduced = flightServiceClient.reduceSeats(</span>
<span class="fc" id="L46">                    request.getFlightId(),</span>
<span class="fc" id="L47">                    request.getNumberOfSeats()</span>
            );

<span class="fc bfc" id="L50" title="All 2 branches covered.">            if (Boolean.FALSE.equals(seatsReduced)) {</span>
<span class="fc" id="L51">                throw new SeatOperationException(&quot;Failed to reduce seats&quot;);</span>
            }

<span class="fc" id="L54">            String pnr = generatePnr();</span>
<span class="fc" id="L55">            Double totalAmount = flight.getPrice() * request.getNumberOfSeats();</span>

<span class="fc" id="L57">            return Booking.builder()</span>
<span class="fc" id="L58">                    .pnr(pnr)</span>
<span class="fc" id="L59">                    .flightId(request.getFlightId())</span>
<span class="fc" id="L60">                    .flightNumber(flight.getFlightNumber())</span>
<span class="fc" id="L61">                    .passengerName(request.getPassengerName())</span>
<span class="fc" id="L62">                    .passengerEmail(request.getPassengerEmail())</span>
<span class="fc" id="L63">                    .passengerPhone(request.getPassengerPhone())</span>
<span class="fc" id="L64">                    .numberOfSeats(request.getNumberOfSeats())</span>
<span class="fc" id="L65">                    .totalAmount(totalAmount)</span>
<span class="fc" id="L66">                    .status(&quot;CONFIRMED&quot;)</span>
<span class="fc" id="L67">                    .bookingDate(LocalDateTime.now())</span>
<span class="fc" id="L68">                    .createdAt(LocalDateTime.now())</span>
<span class="fc" id="L69">                    .updatedAt(LocalDateTime.now())</span>
<span class="fc" id="L70">                    .build();</span>
        })
<span class="fc" id="L72">        .subscribeOn(Schedulers.boundedElastic())</span>
<span class="fc" id="L73">        .flatMap(bookingRepository::save)</span>
<span class="fc" id="L74">        .doOnSuccess(booking -&gt; {</span>
<span class="fc" id="L75">            log.info(&quot;Booking created successfully with PNR: {}&quot;, booking.getPnr());</span>
<span class="fc" id="L76">            sendBookingEmail(booking);</span>
<span class="fc" id="L77">        })</span>
<span class="fc" id="L78">        .map(this::mapToResponse);</span>
    }

    @Override
    @CircuitBreaker(name = &quot;bookingService&quot;, fallbackMethod = &quot;cancelBookingFallback&quot;)
    public Mono&lt;BookingResponse&gt; cancelBooking(String pnr) {
<span class="fc" id="L84">        return bookingRepository.findByPnr(pnr)</span>
<span class="fc" id="L85">                .switchIfEmpty(Mono.error(new BookingNotFoundException(&quot;Booking not found with PNR: &quot; + pnr)))</span>
<span class="fc" id="L86">                .flatMap(booking -&gt; {</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">                    if (&quot;CANCELLED&quot;.equals(booking.getStatus())) {</span>
<span class="fc" id="L88">                        return Mono.error(new BookingAlreadyCancelledException(&quot;Booking already cancelled&quot;));</span>
                    }

<span class="fc" id="L91">                    return Mono.fromCallable(() -&gt; {</span>
<span class="fc" id="L92">                        Boolean seatsRestored = flightServiceClient.restoreSeats(</span>
<span class="fc" id="L93">                                booking.getFlightId(),</span>
<span class="fc" id="L94">                                booking.getNumberOfSeats()</span>
                        );

<span class="fc bfc" id="L97" title="All 2 branches covered.">                        if (Boolean.FALSE.equals(seatsRestored)) {</span>
<span class="fc" id="L98">                            throw new SeatOperationException(&quot;Failed to restore seats&quot;);</span>
                        }

<span class="fc" id="L101">                        booking.setStatus(&quot;CANCELLED&quot;);</span>
<span class="fc" id="L102">                        booking.setUpdatedAt(LocalDateTime.now());</span>
<span class="fc" id="L103">                        return booking;</span>
                    })
<span class="fc" id="L105">                    .subscribeOn(Schedulers.boundedElastic())</span>
<span class="fc" id="L106">                    .flatMap(bookingRepository::save);</span>
                })
<span class="fc" id="L108">                .doOnSuccess(booking -&gt; log.info(&quot;Booking cancelled successfully: {}&quot;, pnr))</span>
<span class="fc" id="L109">                .map(booking -&gt; BookingResponse.builder()</span>
<span class="fc" id="L110">                        .pnr(booking.getPnr())</span>
<span class="fc" id="L111">                        .flightNumber(booking.getFlightNumber())</span>
<span class="fc" id="L112">                        .passengerName(booking.getPassengerName())</span>
<span class="fc" id="L113">                        .numberOfSeats(booking.getNumberOfSeats())</span>
<span class="fc" id="L114">                        .totalAmount(booking.getTotalAmount())</span>
<span class="fc" id="L115">                        .status(booking.getStatus())</span>
<span class="fc" id="L116">                        .bookingDate(booking.getBookingDate())</span>
<span class="fc" id="L117">                        .message(&quot;Booking cancelled successfully&quot;)</span>
<span class="fc" id="L118">                        .build());</span>
    }

    @Override
    public Mono&lt;Booking&gt; getBookingByPnr(String pnr) {
<span class="fc" id="L123">        return bookingRepository.findByPnr(pnr)</span>
<span class="fc" id="L124">                .switchIfEmpty(Mono.error(new BookingNotFoundException(&quot;Booking not found with PNR: &quot; + pnr)));</span>
    }

    private String generatePnr() {
<span class="fc" id="L128">        return &quot;PNR&quot; + UUID.randomUUID().toString().substring(0, 8).toUpperCase();</span>
    }

    private BookingResponse mapToResponse(Booking booking) {
<span class="fc" id="L132">        return BookingResponse.builder()</span>
<span class="fc" id="L133">                .pnr(booking.getPnr())</span>
<span class="fc" id="L134">                .flightNumber(booking.getFlightNumber())</span>
<span class="fc" id="L135">                .passengerName(booking.getPassengerName())</span>
<span class="fc" id="L136">                .numberOfSeats(booking.getNumberOfSeats())</span>
<span class="fc" id="L137">                .totalAmount(booking.getTotalAmount())</span>
<span class="fc" id="L138">                .status(booking.getStatus())</span>
<span class="fc" id="L139">                .bookingDate(booking.getBookingDate())</span>
<span class="fc" id="L140">                .message(&quot;Booking created successfully&quot;)</span>
<span class="fc" id="L141">                .build();</span>
    }

    private void sendBookingEmail(Booking booking) {
<span class="fc" id="L145">        EmailNotification notification = EmailNotification.builder()</span>
<span class="fc" id="L146">                .to(booking.getPassengerEmail())</span>
<span class="fc" id="L147">                .subject(&quot;Flight Booking Confirmation - &quot; + booking.getPnr())</span>
<span class="fc" id="L148">                .body(buildEmailBody(booking))</span>
<span class="fc" id="L149">                .pnr(booking.getPnr())</span>
<span class="fc" id="L150">                .flightNumber(booking.getFlightNumber())</span>
<span class="fc" id="L151">                .passengerName(booking.getPassengerName())</span>
<span class="fc" id="L152">                .build();</span>

<span class="fc" id="L154">        emailService.sendBookingConfirmation(notification);</span>
<span class="fc" id="L155">    }</span>

    private String buildEmailBody(Booking booking) {
<span class="fc" id="L158">        return String.format(&quot;&quot;&quot;</span>
                Dear %s,

                Your flight booking has been confirmed!

                Booking Details:
                PNR: %s
                Flight Number: %s
                Number of Seats: %d
                Total Amount: Rs. %.2f
                Booking Date: %s

                Thank you for choosing our service!

                Best Regards,
                Flight Booking Team&quot;&quot;&quot;,
<span class="fc" id="L174">                booking.getPassengerName(),</span>
<span class="fc" id="L175">                booking.getPnr(),</span>
<span class="fc" id="L176">                booking.getFlightNumber(),</span>
<span class="fc" id="L177">                booking.getNumberOfSeats(),</span>
<span class="fc" id="L178">                booking.getTotalAmount(),</span>
<span class="fc" id="L179">                booking.getBookingDate()</span>
        );
    }

    private Mono&lt;BookingResponse&gt; createBookingFallback(Exception e) {
<span class="nc" id="L184">        log.error(&quot;Circuit breaker activated for createBooking: {}&quot;, e.getMessage());</span>
<span class="nc" id="L185">        return Mono.just(BookingResponse.builder()</span>
<span class="nc" id="L186">                .message(&quot;Service temporarily unavailable. Please try again later.&quot;)</span>
<span class="nc" id="L187">                .status(&quot;FAILED&quot;)</span>
<span class="nc" id="L188">                .build());</span>
    }

    private Mono&lt;BookingResponse&gt; cancelBookingFallback(String pnr, Exception e) {
<span class="nc" id="L192">        log.error(&quot;Circuit breaker activated for cancelBooking: {}&quot;, e.getMessage());</span>
<span class="nc" id="L193">        return Mono.just(BookingResponse.builder()</span>
<span class="nc" id="L194">                .pnr(pnr)</span>
<span class="nc" id="L195">                .message(&quot;Service temporarily unavailable. Please try again later.&quot;)</span>
<span class="nc" id="L196">                .status(&quot;FAILED&quot;)</span>
<span class="nc" id="L197">                .build());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>